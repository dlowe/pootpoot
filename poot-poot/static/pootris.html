<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
 <link rel="icon" type="image/vnd.microsoft.icon" href="/favicon.ico"/>
 <link rel="stylesheet" type="text/css" href="/pootpoot.css"/>

 <script type="text/javascript" src="/jquery-1.3.2.min.js"></script>
 <script type="text/javascript" src="/pootpoot.js"></script>
 <script type="text/javascript">

function _fixposition(X,Y,total_position) {
    var position = total_position;
    if (position == (2 * (X + Y))) {
        position = 0;
    }
    if (position == -1) {
        position = (2 * (X + Y)) - 1;
    }
    return position;
}

function _xy(x,y) {
    return $("#pootris_" + x + '_' + y);
}

function _edge(X,Y,position,c) {
    var x       = 0;
    var y       = 0;
    var drop_x  = 0;
    var drop_y  = 0;
    var delta_x = 0;
    var delta_y = 0;

    if (position < X) {
        x       = position + 1;
        y       = 0;
        drop_x  = x;
        drop_y  = 1;
        delta_y = 1;
        if (c == 'P') {
            delta_x = 1;
        } else if (c == 'O') {
            delta_x = 0;
        } else {
            delta_x = -1;
        }
    } else if (position < (X+Y)) {
        x       = X + 1;
        y       = position - X + 1;
        drop_x  = X;
        drop_y  = y;
        delta_x = -1;
        if (c == 'P') {
            delta_y = 1;
        } else if (c == 'O') {
            delta_y = 0;
        } else {
            delta_y = -1;
        }
    } else if (position < (X+Y+X)) {
        x       = (X + 1) - (position - X - Y + 1);
        y       = Y + 1;
        drop_x  = x;
        drop_y  = Y;
        delta_y = -1;
        if (c == 'P') {
            delta_x = -1;
        } else if (c == 'O') {
            delta_x = 0;
        } else {
            delta_x = 1;
        }
    } else {
        x       = 0;
        y       = (Y + 1) - (position - X - Y - X + 1);
        drop_x  = 1;
        drop_y  = y;
        delta_x = 1;
        if (c == 'P') {
            delta_y = -1;
        } else if (c == 'O') {
            delta_y = 0;
        } else {
            delta_y = 1;
        }
    }

    return {
        'edgebox': _xy(x, y),
        'dropbox': _xy(drop_x, drop_y),
        'drop_x':  drop_x,
        'drop_y':  drop_y,
        'delta_x': delta_x,
        'delta_y': delta_y
    };
}

function _c() {
    return "POOT".charAt(r(0,3));
}

function pootris (target, X, Y, timeout) {
    var h = '<div id="pootris_left">left</div><div id="pootris_right">right</div><div id="pootris_drop">drop</div><table id="pootris_table" cellpadding=0 cellspacing=0>';
    for (var y = 0; y < (Y + 2); ++y) {
        h += '<tr>';
        for (var x = 0; x < (X + 2); ++x) {
            h += '<td id="pootris_' + x + '_' + y + '"/>';
        }
        h += '</tr>';
    }
    h += '</table>';
    target.html(h);

    $("#pootris_table").css({'margin': '0px auto'});
    for (var y = 0; y < (Y + 2); ++y) {
        for (var x = 0; x < (X + 2); ++x) {
            _xy(x, y).css({
                'width':            12,
                'min-width':        12,
                'max-width':        12,
                'height':           24,
                'min-height':       24,
                'max-height':       24,
                'overflow':         'hidden',
                'text-align':       'center',
                'border-width':     1,
                'border-style':     'dotted',
                'font-family':      'Impact,sans-serif',
                'color':            '#FFFFFF',
                'background-color': '#000000',
            });
            _xy(x, y).text(' ');
        }
    }

    var piece = function() {
        var ready    = 1;
        var position = 0;
        var c        = _c();
        var edge     = _edge(X,Y,position,c);
        edge.edgebox.text(c);

        return {
            'counterclockwise': function () {
                if (ready) {
                    edge.edgebox.text(' ');
                    position = _fixposition(X,Y,position - 1);
                    edge = _edge(X,Y,position,c);
                    edge.edgebox.text(c);
                }
            },
            'clockwise': function () {
                if (ready) {
                    edge.edgebox.text(' ');
                    position = _fixposition(X,Y,position + 1);
                    edge = _edge(X,Y,position,c);
                    edge.edgebox.text(c);
                }
            },
            'drop': function () {
                if (ready && (edge.dropbox.text() == ' ')) {
                    ready = 0;
                    edge.edgebox.text(' ');

                    // drop piece
                    edge.dropbox.text(c);
                    var dx = edge.delta_x;
                    var dy = edge.delta_y;
                    var x  = edge.drop_x;
                    var y  = edge.drop_y;

                    var animate = function () {
                        if ((x + dx) == (X + 1)) {
                                // bounce off the right wall
                                if (dy == 0) {
                                    dx = 0;
                                    dy = 1;
                                }
                                dx *= -1;
                        } else if ((x + dx) == 0) {
                                // bounce off the left wall
                                if (dy == 0) {
                                    dx = 0;
                                    dy = 1;
                                }
                                dx *= -1;
                        }

                        if ((y + dy) == 0) {
                                // bounce off the ceiling
                                dy *= -1;
                        }

                        if ((_xy(x + dx, y + dy).text() == ' ') && ((y + dy) < (Y + 1))) {
                            // move the piece
                            _xy(x, y).text(' ');
                            x += dx;
                            y += dy;
                            _xy(x, y).text(c);

                            // next!
                            timeout.set(animate);
                        } else {
                            // the piece stopped

                            var clearpoots = function () {
                                // remove debris
                                for (var clear_x = 1; clear_x <= X; ++clear_x) {
                                    for (var clear_y = Y; clear_y >= 1; --clear_y) {
                                        while (_xy(clear_x, clear_y).text() == '*') {
                                            for (var drop_y = clear_y; drop_y >= 2; --drop_y) {
                                                _xy(clear_x, drop_y).text(_xy(clear_x, drop_y - 1).text());
                                            }
                                            _xy(clear_x, 1).text(' ');
                                        }
                                    }
                                }
                                
                                // check for new POOT
                                var poot_spots = [];
                                for (var start_x = 1; start_x <= X; ++start_x) {
                                    for (var start_y = 1; start_y <= Y; ++start_y) {
                                        for (var dir_x = -1; dir_x < 2; ++dir_x) {
                                            for (var dir_y = -1; dir_y < 2; ++dir_y) {
                                                var found_poot = 1;
                                                for (var i = 0; i < 4; ++i) {
                                                    if ("POOT".charAt(i) != _xy(start_x+(i*dir_x), start_y+(i*dir_y)).text()) {
                                                        found_poot = 0;
                                                    }
                                                }
                                                if (found_poot) {
                                                    for (var i = 0; i < 4; ++i) {
                                                        poot_spots.push([start_x+(i*dir_x), start_y+(i*dir_y)]);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                if (poot_spots.length) {
                                    for (var i = 0; i < poot_spots.length; ++i) {
                                        _xy(poot_spots[i][0], poot_spots[i][1]).text('*');
                                    }
                                    timeout.set(clearpoots);
                                }
                            };
                            clearpoots();

                            // check for game over
                            var game_over = 1;
                            for (var cx = 0; cx < X; ++cx) {
                                if (_xy(cx + 1, 1).text() == ' ') {
                                    game_over = 0;
                                }
                                if (_xy(cx + 1, Y).text() == ' ') {
                                    game_over = 0;
                                }
                            }
                            for (var cy = 0; cy < Y; ++cy) {
                                if (_xy(1, cy + 1).text() == ' ') {
                                    game_over = 0;
                                }
                                if (_xy(X, cy + 1).text() == ' ') {
                                    game_over = 0;
                                }
                            }
                            if (game_over) {
                                return;
                            }

                            // next piece!
                            position = 0;
                            c        = _c();
                            edge     = _edge(X,Y,position,c);
                            edge.edgebox.text(c);
                            ready = 1;
                        }
                    };
                    timeout.set(animate);
                }
            }
        }
    }();

    $("#pootris_left").click(piece.counterclockwise);
    $("#pootris_right").click(piece.clockwise);
    $("#pootris_drop").click(piece.drop);
}

function pootpoot () {
    var timeout_id = null;
    var timeout = {
        'set': function (f, t) {
            timeout_id = setTimeout(f, 50);
        },
        'clear': function () {
            clearTimeout(timeout_id);
        }
    };

    return {
        'start': function (target) { pootris(target, 5, 5, timeout) },
        'stop':  function () { timeout.clear(); },
    };
}

  $(function () {
   colorize($("body"));
   colorize($("#content"));
   var interpretation = pootpoot();
   interpretation.start($("#content"));

   $("#button_pootpoot").click(function (eventObject) {
       eventObject.preventDefault();
       colorize($("body"));
       colorize($("#content"));
       interpretation.stop();
       interpretation = pootpoot();
       interpretation.start($("#content"));
   });
  });
 </script>
</head>

<body>
 <div id="interpretation">
  <div id="title"></div>
  <div id="content"></div>
 </div>
 <div id="buttons">
  <a id="button_pootpoot" href="#">[POOT POOT]</a>&nbsp;
  <a id="button_list" href="/list_interpretations/">[List]</a>
 </div>
</body>

</html>
