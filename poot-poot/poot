#!/usr/bin/env python
"""fetch metadata describing a single random interpretation"""

import random
import logging

from pypoot import interpretation

from google.appengine.ext import db
from google.appengine.ext import webapp
from google.appengine.ext.webapp.util import run_wsgi_app

class Poot(webapp.RequestHandler):
    def get(self):
        key = ''
        if self.request.get('key'):
            key = db.Key(self.request.get('key'))
        else:
            query = db.GqlQuery("SELECT __key__ FROM Interpretation WHERE is_active = TRUE")
            keys = query.fetch(1000)
            key = random.choice(keys)

        i = db.get(key)
        self.response.headers.add_header('content-type', 'text/plain')
        self.response.out.write("""{
 "id": %(id)d,
 "type": "%(type)s",
 "location": "/i/%(key)s"
}""" % {'id': key.id(), 'key': key, 'type': i.type })

application = webapp.WSGIApplication([('/poot', Poot)], debug=True)

def main():
    run_wsgi_app(application)

if __name__ == "__main__":
    main()
